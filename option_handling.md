## オプションの表記

```text
genice3 A15 --cation 0=N :group 1=methyl 6=methyl \
    --cation 4=N :group 3=methyl \
    --anion 2=Cl 8=Br \
    --rep 2 2 2 \
    --seed 99 \
    --exporter svg :shadow :rotate x=5 y=2 x=3 :size O=0.3 H=0.1 HB=0.05 :water 4site^ice
```

- 第一引数はunit cell。これだけは第0階層として扱う。省略不可。
- 第一階層(base)オプションは`--`ではじめる。
- オプションの引数の個数は固定の場合も可変の場合もある。複数の値は空白で区切る。
- unit cellのオプション(cation, anion, guest, densityなど)は第一階層となる。
  - ユーザーからは、unit cellのオプションと、グローバルオプション(--seedなど)は区別がつかない。説明する場合もそこは区別しない。
- 第二階層オプション(オプションの引数のオプション)は`:`ではじめる。
- 第二階層オプションがつけられるのは、第一階層オプションの引数が1個だけの場合のみ。
- 第三階層以降は使わない。
- 原子、分子、イオンのオプションは、空白を入れず`^`でつなぐ。
- option parserはすべてのオプションを構造体におさめる。各モジュールをそれらを「消費」する。残った未使用オプションがある場合は警告する。typoもこれに含まれる。オプションは「消費」されるので、一度のみ効力を持つ。
  - unit cell が "CIF" (unitcell/CIF.py) の場合は CIF ファイル名をオプションで与えるなど、第一階層オプションの種類は unit cell に依存して増える。パース時点では第一階層・第二階層のどれが「正解」かはわからない。よってパーサーは**形式さえ整っていれば**すべて読みとって構造体に入れる。解釈（そのオプションが有効か、何を意味するか）は利用する側（unit cell モジュール、exporter など）に委ねる。
  - オプションの引数の値はパーサーではすべて文字列として記録する。内容の解釈は消費する側が行う。引数に `=` を含むものがあれば辞書として記録し、それ以外はリストとして記録する。同一オプションの複数引数で `=` を含むものと含まないものが混在している場合はエラーとする。
- YAMLはこの構造体をそのまま表現する。ただしunit cell名だけは第一階層と同列にする。YAMLでは文字列を引用符でくくる必要がないので、`cation: 0=N` のように書いてよい。同一オプションが複数ある場合（CLI の `--cation 0=N --cation 1=K` に対応）は、YAMLではキーを1つにし、値を辞書でまとめて書く。例: `cation: { "0": N, "1": K }` またはブロックで `cation:` の下に `"0": N` と `"1": K` を並べる。

**例**
不可 (cation の引数が 2 個のため、サブオプションが後者にかかるのか、両方にかかるのかがわかりにくい)

```shell
--cation 0=N 1=K :group 1=methyl
```

可

```shell
--cation 0=N --cation 1=K :group 1=methyl
```

**YAMLでの表記**

パーサーは `=` で分割せず、引数をそのまま文字列として記録する。複数回の `--cation` は「リスト」になり、各要素は **スカラー**（引数1個のみ・サブオプションなし）または **1 キーの辞書** `{ 引数: サブオプション辞書 }`。リストのリストにせず、スカラー or 辞書にすることで YAML で「1段少ない」形になる。

- CLI: `--cation 0=N --cation 1=K :group 1=methyl`
- データ構造: `cation` はリスト。各要素はスカラー（引数文字列）または `{ 引数文字列: サブオプション辞書 }`。
- 要素1個のリストはスカラーに置き換えてよい。つまり `[0=N]` は `0=N` と書いてよい（パーサー・YAMLローダーは両方を受け付ける）。
- YAML 例:

```yaml
unitcell:
  name: A15
  cation:
    - 0=N
    - 1=K:
        group: [1=methyl]
```

利点: パーサーは「辞書かリストか」「`=` 混在でエラー」などのルールが不要。解釈はすべて消費する側。YAML も「同じオプションの並び」がそのままリストになり、余計なキーワード（value など）は出てこない。

**YAML での許容**: 上記のように「スカラーとリストを同じシーケンスの要素として混在させる」書き方は、YAML の仕様で許容されている。シーケンスの要素はスカラー・シーケンス・マッピングのどれでもよく、型の混在が可能である。ローダー側ではスカラーが来た場合に要素1個のリスト `[ そのスカラー ]` に正規化すれば、内部表現を統一できる。

---

**冒頭の例の解釈結果**（文字列を空白分割し、上記ルールで構造体に格納した場合。サンプル: `option_parse_sample.py`）

内部構造（スカラー or 1 キー辞書のリスト）:

```text
unitcell: A15
cation: [{'0=N': {'group': ['1=methyl', '6=methyl']}}, {'4=N': {'group': ['3=methyl']}}]
anion: [['2=Cl'], ['8=Br']]
rep: [['2'], ['2'], ['2']]
seed: [['99']]
exporter: [{'svg': {'shadow': [], 'rotate': ['x=5', 'y=2', 'x=3'], 'size': ['O=0.3', 'H=0.1', 'HB=0.05'], 'water': ['4site^ice']}}]
```

表示用（要素1個のリストはスカラーに置換）:

```text
unitcell: A15
cation: [{'0=N': {'group': ['1=methyl', '6=methyl']}}, {'4=N': {'group': ['3=methyl']}}]
anion: ['2=Cl', '8=Br']
rep: ['2', '2', '2']
seed: 99
exporter: [{'svg': {'shadow': [], 'rotate': ['x=5', 'y=2', 'x=3'], 'size': ['O=0.3', 'H=0.1', 'HB=0.05'], 'water': ['4site^ice']}}]
```

同じ内容を YAML で表示（`option_parse_sample.py` は PyYAML があれば単成分リストをスカラーに置換してからこの形式で出力する）:

```yaml
unitcell: A15
cation:
  - 0=N:
      group: [1=methyl, 6=methyl]
  - 4=N:
      group: [3=methyl]
anion: [2=Cl, 8=Br]
rep: ['2', '2', '2']
seed: '99'
exporter:
  - svg:
      shadow: []
      rotate: [x=5, y=2, x=3]
      size: [O=0.3, H=0.1, HB=0.05]
      water: 4site^ice
```

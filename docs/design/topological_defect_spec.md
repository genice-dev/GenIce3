# トポロジカル欠陥（Bjerrum欠陥）の指定方法

## 背景

- トポロジカル欠陥（Bjerrum欠陥、イオン欠陥）は**水分子の位置**ではなく、**2つの水分子の間の水素結合（O–O エッジ）**に乗る欠陥である。
- したがって「どこに置くか」の指定には、**どの O–O エッジか**を一意に指定する必要がある（水分子インデックス 2 つ、またはそれに相当する指定）。
- 立体構造を見ずに、意図したエッジを番号だけで当てるのは難しい。置換イオン（1 サイト指定）よりハードルが高い。

## 指定の候補

### 1. 水分子ペア (i, j) で指定（基本形）

- **指定**: 水分子インデックス 2 つ `(i, j)`。グラフのエッジ `(i, j)` がその O–O 結合に対応する。
- **API 例**: `bjerrum_defects = [("D", 0, 2), ("L", 4, 5)]`（D 欠陥をエッジ (0,2)、L 欠陥を (4,5) に）。
- **利点**: 実装が素直。`graph` のエッジと 1:1。
- **欠点**: 立体を見ないと「どれが (0,2) か」が分からない。

### 2. エッジ番号で指定

- **指定**: `graph.edges()` を何らかの**決まった順序**で列挙したときの 0-based インデックス `k`。
- **API 例**: `bjerrum_defects = [("D", 3), ("L", 7)]`。
- **利点**: 1 つの整数で指定できる。
- **欠点**: どの k がどの空間位置か、一覧がないと分からない。順序は実装に依存するので、ドキュメントと安定列挙が必須。

### 3. エッジ一覧の出力（exporter）

- **内容**: エッジ番号・水分子ペア・（必要なら）中点や両端の分数座標を出す exporter。
  - 例: `genice3 CS2 -rep 2 2 2 -f edge_list > edges.txt`
  - 中身例: `k  i  j  frac_mid_x frac_mid_y frac_mid_z` または `k  (i,j)  (x,y,z)_i  (x,y,z)_j`
- **利点**: 座標と対応表を見て「この座標の近く＝この k」と決められる。立体表示がなくても、座標で狙いのエッジを選べる。
- **実装**: 新規 exporter（例: `edge_list`）を追加。`graph.edges()` の列挙順序を固定（例: `sorted(g.edges())`）すれば再現可能。

### 4. 可視化でノード・エッジにラベルを付ける

- **現状**: plotly ではノード（水分子）に `text=[str(i) for i in normal_nodes]` でインデックスを表示している。
- **拡張**:
  - エッジにもラベルを付ける（例: 中点に `"i-j"` またはエッジ番号 `k` を表示）。
  - オプションで「エッジラベル表示 on/off」を切り替え。
- **利点**: 3D 図を見ながら「(5,12) の間に D 欠陥を置く」と決められる。既存の plotly / py3dmol と相性が良い。
- **欠点**: エッジ数が多いとラベルがごちゃつくので、表示範囲の絞り込みやオプションが欲しくなる。

### 5. 座標に「近い」サイト／エッジを返すヘルパー関数

分数座標 (x, y, z) を 1 つ渡し、最も近いサイトまたはエッジを返す API を用意する案。

- **`site_closeto(x, y, z)`**  
  - 分数座標 `(x, y, z)` に最も近い**水分子（格子サイト）のインデックス**を返す。  
  - 周期境界を考慮した距離で比較する。  
  - **用途**: 置換イオン（spot_cation / spot_anion）を「この座標の近く」で指定したいとき。例: `spot_cations = {genice.site_closeto(0.25, 0.5, 0.1): "Na"}`。

- **`edge_closeto(x, y, z)`**  
  - 分数座標 `(x, y, z)` に最も近い**エッジ**を返す。  
  - 「近い」の定義: エッジの中点への周期境界付き距離、または線分への最短距離のいずれか（仕様で固定）。  
  - 戻り値は `(i, j)` のタプル（水分子インデックス 2 つ）。  
  - **用途**: トポロジカル欠陥を「この付近の結合に置きたい」とき。例: `bjerrum_defects = [("D", *genice.edge_closeto(0.2, 0.3, 0.5))]`。

- **利点**: 座標ベースの直感的な指定ができる。CIF や可視化で目にした座標をそのまま渡せる。  
- **注意**: 周期境界の取り扱いと距離の定義を仕様で明示する。意図しないサイト／エッジが選ばれないよう、必要なら「距離の閾値以内だけ」などのオプションも検討する。

### 6. 単位胞内エッジ + 複製インデックス

- **指定**: 単位胞内のエッジを canonical に番号付けし、replica (r1, r2, r3) と組み合わせる。例: `D=3:(1,0,0)`。
- **利点**: 小さい単位胞なら「単位胞内のエッジ」は数が少なく、一覧と対応付けしやすい。
- **欠点**: rep が大きいと replica の指定が煩雑。拡大単位胞側のグラフではノード番号が replica でずれるので、実装時にマッピングが必要。

## 推奨の組み合わせ

1. **API の基本**: 指定は **(水分子 i, 水分子 j)** のペアで行う（既存の `graph` のエッジと一致）。  
   - 例: `bjerrum_defects: List[Tuple[str, int, int]]` で `("D", i, j)` / `("L", i, j)`。

2. **「どの (i,j) を指定すればよいか」を分かりやすくする**:
   - **エッジ一覧 exporter**: 番号 k と (i, j)、および必要なら座標を出力。ユーザーは座標や隣接関係から狙いの k を決め、対応する (i, j) を参照して API に渡す（あるいは将来は「エッジ番号 k で指定」も許容する）。
   - **可視化の強化**: plotly（および必要なら py3dmol）でエッジに `(i,j)` またはエッジ番号を表示するオプションを追加。図を見て (i, j) を決めて API に渡す。

3. **CLI**: ToDo の通り、CLI に載せず API で十分とするなら、`-D 0 2 -L 4 5` のようなオプションは後回しでよい。実装する場合は「2 つの水分子インデックス」で `--defect D=0,2 --defect L=4,5` のようにするのが自然。

4. **再現性**: エッジ一覧や可視化で「どのエッジがどの番号か」が seed や rep が同じなら同じになるように、`graph.edges()` の列挙順序を固定（例: `sorted(g.edges())`）しておく。

## まとめ

- **指定の実体**: 常に「どの O–O エッジか」＝水分子ペア (i, j)。
- **使いやすくするため**:  
  - エッジ一覧を出す exporter と、  
  - 可視化でのエッジラベル表示  
  の 2 つを用意すると、「立体構造を見ずに」でも座標と一覧から狙いのエッジを決められ、「立体を見て」なら図から (i, j) を読める。
- **座標で指定したい場合**: `site_closeto(x,y,z)`（最も近いサイト）と `edge_closeto(x,y,z)`（最も近いエッジ (i,j)）を GenIce3 のヘルパーとして用意すると、CIF や図で見た座標をそのまま渡してサイト／欠陥位置を決められる。置換イオンとトポロジカル欠陥の両方で使える。
